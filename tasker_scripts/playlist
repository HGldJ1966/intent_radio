#!/bin/sh

root='/sdcard/Tasker/.intent_radio'
state="$root/state.txt"
tmp="$state.tmp"
log="$root/log.txt"

exec 4>> $log

log ()
{
   date +"%H:%M.%S $*" >&4
}

log "args $*"
mkdir -p "$root"

ir_play ()
{
   log "play $*"
   [ -n "$*" ] && echo "play" "$@"
}

ir_next ()
{
   log "next"
   [ -f "$state" ] || return
   {
      read item
      log "item $item"
      ir_play "$item"
      cat >&3
   } < "$state" 3> "$tmp" && mv "$tmp" "$state"
}

ir_start ()
{
   file="${1#file://}"
   log "start $file" >&2
   grep -v '^#' "$file" | grep . | grep '://' > "$state"
   cat "$state" >&4
   ir_next
   exit
}

ir_stop ()
{
   [ -f "$state" ] && rm "$state"
}

case "$1" in
   'start'    ) shift; ir_start "$@" ;;
   'next'     ) ir_next ;;
   'complete' ) ir_next ;;
   'stop'     ) ir_stop ;;
esac

